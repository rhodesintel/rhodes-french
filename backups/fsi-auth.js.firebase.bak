/**
 * FSI Course - Google Sheets Analytics
 * Simple webhook-based analytics - no complex auth required
 *
 * SETUP:
 * 1. Create Google Sheet "FSI French Analytics"
 * 2. Extensions → Apps Script → paste google-apps-script.js
 * 3. Deploy → New deployment → Web app → Anyone can access
 * 4. Copy URL and paste below
 */

const FSI_Auth = {
  // Google Sheets webhook URL
  // Paste your deployed Apps Script web app URL here:
  SHEETS_WEBHOOK_URL: '',

  // State
  initialized: false,
  userId: null,
  pendingWrites: [],
  syncInterval: null,

  // For compatibility with existing code
  firestoreEnabled: false,
  authEnabled: false,
  user: null,

  // Initialize
  async init() {
    // Generate anonymous user ID if not exists
    this.userId = localStorage.getItem('fsi_user_id');
    if (!this.userId) {
      this.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('fsi_user_id', this.userId);
    }

    // Load pending writes from storage
    try {
      const pending = localStorage.getItem('fsi_pending_writes');
      if (pending) {
        this.pendingWrites = JSON.parse(pending);
      }
    } catch (e) {}

    this.initialized = true;

    // Flush any pending writes
    if (this.SHEETS_WEBHOOK_URL && this.pendingWrites.length > 0) {
      this.flushPendingWrites();
    }

    // Sync every 60 seconds
    this.syncInterval = setInterval(() => this.flushPendingWrites(), 60000);

    // Update SRS with user ID
    if (typeof FSI_SRS !== 'undefined') {
      FSI_SRS.setUserId(this.userId);
    }

    console.log('Analytics initialized:', this.userId);
    console.log('Sheets sync:', this.SHEETS_WEBHOOK_URL ? 'configured' : 'not configured (local only)');

    this.updateUI();
    return this;
  },

  // Check if sheets sync is configured
  isConfigured() {
    return !!this.SHEETS_WEBHOOK_URL;
  },

  // Save a response to Google Sheets
  async saveResponse(response) {
    const payload = {
      type: 'response',
      payload: {
        ...response,
        userId: this.userId
      }
    };

    if (!this.SHEETS_WEBHOOK_URL) {
      // Queue for later if not configured
      this.pendingWrites.push(payload);
      this.savePendingWrites();
      console.log('Response queued (sheets not configured)');
      return false;
    }

    try {
      // Use no-cors mode - Apps Script doesn't return proper CORS headers
      // but it still processes the request
      await fetch(this.SHEETS_WEBHOOK_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      console.log('Response sent to sheets');
      return true;
    } catch (e) {
      console.warn('Failed to save to sheets:', e.message);
      this.pendingWrites.push(payload);
      this.savePendingWrites();
      return false;
    }
  },

  // Save progress summary
  async saveProgress(progressData) {
    const payload = {
      type: 'progress',
      payload: {
        ...progressData,
        userId: this.userId
      }
    };

    if (!this.SHEETS_WEBHOOK_URL) return false;

    try {
      await fetch(this.SHEETS_WEBHOOK_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      return true;
    } catch (e) {
      console.warn('Failed to save progress:', e.message);
      return false;
    }
  },

  // Flush pending writes
  async flushPendingWrites() {
    if (!this.SHEETS_WEBHOOK_URL || this.pendingWrites.length === 0) return;

    console.log(`Syncing ${this.pendingWrites.length} pending writes to sheets...`);

    const toSend = [...this.pendingWrites];
    this.pendingWrites = [];
    this.savePendingWrites();

    for (const payload of toSend) {
      try {
        await fetch(this.SHEETS_WEBHOOK_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        // Small delay to avoid rate limiting
        await new Promise(r => setTimeout(r, 100));
      } catch (e) {
        // Re-queue failed writes
        this.pendingWrites.push(payload);
      }
    }

    this.savePendingWrites();
    console.log('Sync complete, remaining:', this.pendingWrites.length);
  },

  // Save pending writes to localStorage
  savePendingWrites() {
    try {
      localStorage.setItem('fsi_pending_writes', JSON.stringify(this.pendingWrites));
    } catch (e) {}
  },

  // Get user ID
  getUserId() {
    return this.userId;
  },

  // Update UI
  updateUI() {
    // Hide auth section - we use anonymous tracking
    const authSection = document.getElementById('authSection');
    if (authSection) authSection.style.display = 'none';

    const authBtn = document.getElementById('authBtn');
    if (authBtn) authBtn.style.display = 'none';

    const userInfo = document.getElementById('userInfo');
    if (userInfo) userInfo.style.display = 'none';
  },

  // Compatibility stubs
  initFirestore() { return false; },
  signInWithGoogle() { return null; },
  signInWithEmail() { return null; },
  createAccount() { return null; },
  signOut() {},
  getUser() { return null; },
  isSignedIn() { return false; },
  getUserProfile() { return { uid: this.userId, email: null, displayName: 'Anonymous' }; }
};

// Export
if (typeof module !== 'undefined') {
  module.exports = FSI_Auth;
}
